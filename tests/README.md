# Integration Tests

This directory contains integration tests for rigrun that verify the full request flow works correctly by hitting the live server.

## Running the Tests

The integration tests are marked with `#[ignore]` so they don't run in CI without a server. To run them:

### 1. Start the rigrun server

```powershell
rigrun
```

Or in a separate terminal:

```powershell
cd C:\rigrun
cargo run
```

### 2. Run the integration tests

```powershell
cargo test --test integration_tests -- --ignored
```

This will run all integration tests that connect to http://localhost:8787.

## Test Coverage

The integration tests cover:

1. **Health Endpoint** (`test_health_endpoint`)
   - Verifies `/health` returns correct status and version

2. **Models Endpoint** (`test_models_endpoint`)
   - Verifies `/v1/models` lists available models
   - Checks for "auto", "local", and "cloud" models

3. **Cache Stats Endpoint** (`test_cache_stats_endpoint`)
   - Verifies `/cache/stats` returns cache statistics
   - Validates hit rate is between 0-100%

4. **Query Routing** (`test_query_routing`, `test_query_routing_local`)
   - Verifies `/v1/chat/completions` correctly routes queries
   - Tests both auto routing and explicit local routing
   - Validates response format and content

5. **Stats Tracking** (`test_stats_tracking`, `test_stats_endpoint_structure`)
   - Verifies `/stats` endpoint returns session and daily statistics
   - Validates stats increment after queries
   - Checks all required fields are present

6. **Cache Behavior** (`test_cache_hit_behavior`)
   - Tests semantic caching works correctly
   - Makes duplicate requests to verify cache hits

## Test Generation

These tests were generated using rigrun itself! Each test was generated by making requests to the local rigrun server at http://localhost:8787/v1/chat/completions with prompts describing the desired test behavior.

The generation script is available at `generate_test.ps1`.

## Notes

- Tests require a running rigrun server on port 8787
- Tests are designed to be idempotent and not interfere with each other
- All tests use proper error handling with `Result<(), Box<dyn std::error::Error>>`
- Tests use `#[tokio::test]` for async support
- Tests use `#[ignore]` to prevent running in CI without server setup
