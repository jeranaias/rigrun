# Copyright (c) 2024-2025 Jesse Morgan / Morgan Forge
# SPDX-License-Identifier: AGPL-3.0-or-later

name: rigrun CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allow manual runs from the Actions tab
  workflow_dispatch:

# Restrict default token permissions for security
permissions:
  contents: read

# Cancel in-progress runs of this workflow on the same branch/PR when new commits are pushed
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (stable, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          components: clippy, rustfmt

      # Cache target/ and cargo registry/git to speed up builds
      - name: Cache cargo build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          # Explicit key helps isolate this project's cache
          shared-key: rigrun
          # If you have a workspace, this line will still work; otherwise it's just the root crate
          workspaces: |
            . -> target

      - name: Show Rust and cargo versions
        run: |
          rustc --version
          cargo --version

      - name: cargo check
        run: cargo check --all-targets --all-features

      - name: cargo test
        # --locked ensures Cargo.lock stays in sync with Cargo.toml
        run: cargo test --all-features --all-targets --locked

      - name: cargo fmt --check
        run: cargo fmt --all -- --check

      - name: cargo clippy
        # -D warnings turns all lints into errors to keep the codebase clean
        run: cargo clippy --all-targets --all-features -- -D warnings

  # =============================================================================
  # Go Tests (Full Coverage)
  # =============================================================================
  go-test:
    name: Go Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go-tui/go.sum

      - name: Download Go dependencies
        working-directory: go-tui
        run: go mod download

      - name: Go Build Check
        working-directory: go-tui
        run: go build -v ./...

      - name: Go Tests
        working-directory: go-tui
        run: go test -v -timeout 5m ./...

      - name: Go Vet
        working-directory: go-tui
        run: go vet ./...

  # =============================================================================
  # Go Security Tests (Classification Routing - 100% Coverage Required)
  # =============================================================================
  go-security-tests:
    name: Go Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go-tui/go.sum

      - name: Run Security-Critical Tests
        working-directory: go-tui
        run: |
          echo "=== SECURITY-CRITICAL TEST SUITE ==="
          echo "Testing classification routing (NIST 800-53 AC-4 compliance)"
          go test -v -timeout 5m ./internal/router/... -run "Classification|Adversarial|Paranoid"
          echo ""
          echo "Testing security lockout mechanisms"
          go test -v -timeout 5m ./internal/security/... -run "Lockout|Integrity|Paranoid"
          echo ""
          echo "Testing audit HMAC key management (NIST 800-53 AU-9)"
          go test -v -timeout 5m ./internal/security/audit/...

      - name: Verify No Cloud Routing for Classified Data
        working-directory: go-tui
        run: |
          echo "=== VERIFYING CLASSIFICATION ENFORCEMENT ==="
          # Run specific tests that verify classified data never routes to cloud
          go test -v -timeout 2m ./internal/router/... -run "CUIForcesLocal|SecretForcesLocal|TopSecretForcesLocal|ConfidentialForcesLocal"

  # =============================================================================
  # Go Test Coverage
  # =============================================================================
  go-coverage:
    name: Go Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go-tui/go.sum

      - name: Run Tests with Coverage
        working-directory: go-tui
        run: |
          go test -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out | tail -20

      - name: Check Security Package Coverage
        working-directory: go-tui
        run: |
          echo "=== SECURITY PACKAGE COVERAGE ==="
          go test -coverprofile=security_coverage.out -covermode=atomic ./internal/security/... ./internal/router/...
          go tool cover -func=security_coverage.out | grep -E "^total:|router|security"

          # Extract total coverage percentage
          COVERAGE=$(go tool cover -func=security_coverage.out | grep "^total:" | awk '{print $3}' | tr -d '%')
          echo "Security package coverage: ${COVERAGE}%"

          # Warn if coverage is below 70%
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "::warning::Security package coverage is below 70%"
          fi

  # =============================================================================
  # Race Detection Tests (Concurrency Safety)
  # =============================================================================
  race-detection:
    name: Race Detection
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # Go Race Detection
      # -------------------------------------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go-tui/go.sum

      - name: Go race detection tests
        working-directory: go-tui
        run: |
          echo "Running Go tests with race detector..."
          go test -race -v -timeout 5m ./internal/...
        continue-on-error: false

      # -------------------------------------------------------------------------
      # Rust Thread Safety Tests
      # -------------------------------------------------------------------------
      - name: Install Rust stable toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rigrun-race
          workspaces: |
            . -> target

      - name: Rust thread safety tests
        run: |
          echo "Running Rust concurrency tests..."
          cargo test --test race_detection_test -- --test-threads=4
        continue-on-error: false

      - name: Rust integration tests (thread-safe)
        run: |
          echo "Running Rust tests with multi-threading..."
          SKIP_INTEGRATION_TESTS=1 cargo test --all-features -- --test-threads=4
        continue-on-error: false

  # =============================================================================
  # Nightly Race Detection (ThreadSanitizer - Linux only)
  # =============================================================================
  thread-sanitizer:
    name: ThreadSanitizer (Nightly)
    runs-on: ubuntu-latest
    # Only run on main branch or manual dispatch to save CI time
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust nightly toolchain with rust-src
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
          profile: minimal
          components: rust-src

      - name: Run ThreadSanitizer tests
        env:
          RUSTFLAGS: "-Z sanitizer=thread"
        run: |
          echo "Running Rust tests with ThreadSanitizer..."
          cargo +nightly test --target x86_64-unknown-linux-gnu --test race_detection_test -- --test-threads=1
        continue-on-error: true  # TSAN can be flaky, don't block CI

  # =============================================================================
  # Rust Security Tests (Classification Routing Enforcement)
  # =============================================================================
  rust-security-tests:
    name: Rust Security Tests
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: Cache cargo build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rigrun-security

      - name: Run Rust Security Tests
        run: |
          echo "=== RUST SECURITY TEST SUITE ==="
          echo "Testing classification routing enforcement..."
          cargo test --lib router -- --test-threads=1
          echo ""
          echo "Testing session management (DoD STIG AC-12)..."
          cargo test --lib security -- --test-threads=1
          echo ""
          echo "Testing audit logging..."
          cargo test --lib audit -- --test-threads=1

      - name: Verify Classification Enforcement
        run: |
          echo "=== VERIFYING CUI/SECRET NEVER ROUTES TO CLOUD ==="
          cargo test --lib -- test_tier_escalation_cui_blocked --test-threads=1
          cargo test --lib -- test_classification_enforcement --test-threads=1
          cargo test --lib -- test_paranoid_mode_enforcement --test-threads=1

  # =============================================================================
  # CI Status Summary (Required for Branch Protection)
  # =============================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [test, go-test, go-security-tests, race-detection, rust-security-tests]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "=== CI STATUS SUMMARY ==="
          echo "Rust Tests: ${{ needs.test.result }}"
          echo "Go Tests: ${{ needs.go-test.result }}"
          echo "Go Security Tests: ${{ needs.go-security-tests.result }}"
          echo "Race Detection: ${{ needs.race-detection.result }}"
          echo "Rust Security Tests: ${{ needs.rust-security-tests.result }}"

          # Fail if any required job failed
          if [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.go-test.result }}" == "failure" ]] || \
             [[ "${{ needs.go-security-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.race-detection.result }}" == "failure" ]] || \
             [[ "${{ needs.rust-security-tests.result }}" == "failure" ]]; then
            echo "::error::One or more required CI jobs failed"
            exit 1
          fi

          echo "All required CI jobs passed!"
